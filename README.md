## Architecture Diagram

### Command-Sequence-Inbound-Diagram

![Alt text](https://lh3.googleusercontent.com/fife/ALs6j_Fmf9G5CenncsKyttnH-Ywq1i4pifC3ypgNQw5d5NFSbiX_PcavRdyHW4vsO0WdvxHffl3usGLuSA2G7nMD1zaQpc-oM9xj1T61_YlhxB3IB_iXius2ij4zWKsyKqc4wvlp0pXBKnDdVaeRGOt0V_DqZCIe0V5QZTrPDd9UTQQ2yv7SkhhsdW7FJn4TLk3BIA1dSufx1UtYhCGSNxIc4zjcv0VLFLIGYahgJ5bGoDb3QLwaKHLLFl1JwjU7u00dbbL_DZk6eVWj6OeNH4jK6gxIpxlOc-nHa8Ut3IEizcA6HZ0UQzFtfLOiD6DDBfmYumrYZc0CNatKxzRUEUh6kldwBU-gTiHy-jf21B-1vN_69E9R5lZ3cWKBfkNpYtLbQsvHA9e7mjKrCPyw9nyN4p2sr7_n5wB8hxO8YsikSLGkcJMHJndhKXJuWnWJPajCgEOUNy4LwpTrAghxlavub7qKbTjnw1fuAdk37N-v67wL2jDhsccrLTNAjTPRlEKNdCbivr5q7w036pbQq8xSiB0CC-1iDf0g1PHxBnlqNfjhlyTA03P55vskGD4soL2J9d12vlL49eNEYbg5DsniPds3HdT5eW16EOZXB5gWm72YDBslnAnXDuenM4URCAa-Pm7GzYr2-vMY8cfWZDWcV7zs0ax3Cq5Yd5dgwU7iX5cQLvT7hkNHXB4IDBEDgV4DKSjzhgjo1EgTbsgSzTsrcOw-cvxjwyDQ2UVDEWrbmOB1K4R79u57M5T9xlanZKYnMNWbVpdkrADOkhfXhUmev6zfqmbWxs7N6BT-7eiMqPXCukUam6K2tNXt85f1_avfMfdPZ9wCQTBnPW29ZW6qkC3NQL_rm3RnSKwpIw3oh6_eEYFlJQuRQCuVdm2ybJ6lBQcQHer3YmUn_LDJDR4fheHx_A1QOGWkyqYseXwioMMT_gXMWnAAuDqkCqov1dN6hcIYMqImRrW4pMweX8m7GSnYSYSRNdzbZYJZdBwL2l91HPbQZxQuQ-YvIscdGuiYZL82XvB3ilU3csaKwVIexZPTWHWvRMQMv2OLVs43u0_22iIdK1tGN96LD0L2_7RHmhgOau7BI-JbXAnC_52wfbGA5997DPTZi8KZrJwdGH7KBJK29Qimf2lhSFqRTicWha-64aolIi0uyOg4tPgmfQMSt2Fy4zEKe6-ZQ-irE_0GzXDrYpGClKnqzeB11ArqkwVcKaFVe_d_MX-1CHARg-I9MkS8DrmYLS8mb6QpVOvNypQJv_9dgVajrDWGJzKGOJbjauiv7dPAKjiWPk_ydNTenllGQBxgmo5wqTCCHBOQD9fd9cKNklMxgVHi0f2UTjar5hu0r_VxYybr0fDSKMzCZFflQfPchO5Ntf-2UnLlw6Fs3364MbyMqNnBrRmcGhUEghBGVqxGdgWYDZfF-BgXkwCgX73DOpQbqzBZelT8qxOJUCylNBGgueVPvAH6_QqU0tztdkLVE3Z_18dnp4Io10PKA3hePQ4gKWj97oxYeBsSjWPDplBfdfVbvF7Shdh7smII_MWU5d-oMOvpBh7KViRVwtZgRHKOoBNNvhhERrKowh6LBMgsPcl7aj_P9p2dJt_uMA=w3024-h1646)

### Command-Sequence-Order-Diagram

![Alt text](https://lh3.googleusercontent.com/fife/ALs6j_GJ0gvPTlpr4Y3R1Myr0cEFfMEJeQlTRdViFZtV2acavPbt0vBhBABaz1xQbHfHrBn3bQB3Vmw-9Nkai7n03MccMFTNqaerQWzm0S2JjtVE0-PyEBkaWQVLPhZO34tVJRlYvXSrdyAY04gRBPcXG7AToUage4XldJ-groOBaUe0DrPa5c0MrDTwv1zrnPBKisCbfDx6Q02d3_fnJYR1EmE1L8lHdNQQLlDHYs0yv4vTZDe6WrHb7VWsKm5qH-cWT-DUwFWCC2HE_8QMNzkVIRuk6k6blullKQznDbjPKboY6vOB7fshGmZDKnL7XFnX0nEw3FGmflqTrjjUkdF47I2yMvco5qGaqI339QsOfXIgUQNTBg2y-d3jp4RnHoclQ-dp8ChS7TpLbRq8_t1ySKgwcS76W4pjZ8PgDVnLg_NMWqbAgGF5-Pff2FMNd3GQb_jgDbzmlrjzlD8hyeE5QDknli2osmvJvV1iX0BbNBkOmmroJ-NmZmRfo0YhFODTdbOsRCkIu9fhlq7_8Znnk1ega9uxPv0FZivuOSgo_wrzSu9H9b85idvcjiJXx_dF_kwdC6H-EdbawQmbX6teWc9HtkglVNOuDmncL-k8SmtZt4ZsF9Kfbs8vSOzfn1wNsljiDkLH-wAvHZwyCGYSfIYxd0L6MeSrmMI_SdxBtjf7_zZ0WYDGOLNYmE_qDYXf_ZkmXuHzOCU_ODOImsX1KhUt9hIrCSu5z-TijY-_dA3yanLHqgw1fLvjhqOjc7HAvRUrG1gMOC1opmlPj_kKeOVSNMvJlMYEfM0vsxzarlQj4JhhJ_EOBr35hFDqtfQzy7Nl3umyWmJvVXZl-AUNJ-m_87vG3O7KiAK16v8Ir9DyiSkVEqg7GdraXt9_PR2ihBJs41e-FX7b5bBqYyPT_cH2yCzuy-1GrsdHgNSiWru46uG42JkFPffH8u1Bukn80LNswVipOJ4vtMtOyRHYLMVSzBouqxPYl6CHckKxj7ohFOktLI-UQgm5Zgb_Uj0R8WRgdshIlB-kte_c-HO6q6QZvhVdRBvw31lgEQgwdg3l_0Q8OJ799-iThF8kV2m6rzVUZl5mzI4PneoaEIwyNPthxCVXzorv8nM6JodKQ41CTi2HCxecmTYppzu8sXU6Jj9GCSQFXiGbAAOOPY-mKNZYzZNzrJj5gw3UlnkJUTwsckCwp6CG0HjvXL6QPShtFZdZdkZXNn4p1Nmd5r5ENkduzx6iG4BjJwG444CQSoJDkFFbEMgcWe5_werZ6mCjlMuj8SzFXcbjUxBWfx4b8SpWQdWp1dZNPRyCiBU66iiYhjiONDPUIfV7Npqn-iE0_PJpjOxvN216WrzKmBpUbS4wpqodW3nRlRtndtp2j8REuOYhIT0my98JW1DGK36PBlG7jUIVL_OPLP3JxMWbrdozwsI1gj5BHkW2VdDitZcaHXi8kSI8NbDE4LpY0cYfWiTug4Ax-H3ssEZ0SFuIa1qKe83zcEg58AMpPnN-UlzUJIkp2ltzNBN7vEHG16-5IJIy8nfirHetB18hfxe7US2qDJmDGWImSQbLe2-PsoAQP1IsNAIBB5oVRvtQhi3inIStvFZH=w3024-h1646)


### Query-Sequence-Diagram

![Alt text](https://lh3.googleusercontent.com/fife/ALs6j_F50Po-GrE1M217Fft2iLS-HHsR4RxvhOgZyE3qM32KSWjaITpjP5tHpsFP9uaoEzFYpmD_HwBtlnJROseaOtSsRwXsFpa7_RbedlwajRi10qUWxQAGD6bYH4QIeji9nfbzS24snHU4H_snG5t4HLdg_gepGRpoi3xtTxNRQH0egJZNHwN640ozjIMpWK2nruEZjMxB-loVwT9IXPm9CmdBOP6ZaYlse4EKTSDxhpPZFILBfRp_qbAbGDUz0Bg9B35p-i4hdj2Se1WdrazanBjO2ZMj4NumsIFXdMj4cV1vhdzTa5j-SCsD2pgFb2PF1v60AmrKmPytgQAnx3Y71-xpHWFL9AeALG343mJKhQgE-hspo6AvJBXRXTj3pAeu2P86lRASBagb9AiNwSUMwfc35HX3MRdnJ0yW0nI_7G9CU1UfsguuUj_mEAzPoyOD2ATE-UQ5AzQ6e61Tq2VQKoQ65lfWdi9jc9n5nV03agTElMHQClG-VvqqwzZrYg5pAs1EfSetqpr_N_K8p2BkQj91sd1a0NmedF_yxBhDw28YP7zHgR6K4mKfhsQBLzIdkzK03e6PgToCCLXrc44ppKJp5UtYFx4RT9e1qm51mcqKzMsfXQSADNc6IFZIsYKYCR-EsOU40_C-ytNkMT7Q8YI4_XoRrG9wVKS7TGvmsePsT6FIRMX4wnYsoFS2f6Eq6e1ql1Y4nEBGwKqMV36VVsXQtXZpabe33vlvI6q9WCSQpdr-QgK5MxFLdZ_SCpE4neNSusQLPFN7RZypJzn0i87D7z_AvTSj3Jb5YcXNY-yeMDY-4Q7Nfw-inCG1k4NHq_vutEQTSU7DNWFvD1zwwkDHricEy_nZ67_ZdM96H6TOCIrBDpFoUizT_PTJSBT1JsOCe6xFc5le6juiVlRmt4qVmkU2lhJaElxeBwv_rDU13lNG7TRJccn674r7yghbEHwGUmdvLX2fJ5heUwFbtdAlLNEGD4Bpj3KpVlJQOdW3j4KDnTPNL8T3NZitTE-EryiKCwVXjKy5-Oy89yaf6moxgz-o0ulh-G28ks0mZm8UvFyy4omCvlCN_U97VhZHMCT6q-Fq_1HrWidR8SugX4kT5QrWFTUs3-e_7YmnB7xMFKWB-aO7GKSTsC_NXaFI6FztLqmbrBXHyFzaxH07Vu4MSkG8ak1ZIxoe7QDN-URpSJ438YxOuzpgFUYsC5FcNGk01Wl0wLcXvRMAaR914yyygnlnnz_FzqA0cU01HZLiFsSgokwQE04_pjXHSnbdelpjaNIWN-v8_Zz2_G6hiANSQeWO3UmpfUn4KEBZjwF7Dn4RFYD9qH-1_ZQaBHlOgQpfZ78xJ1v9RNgV6drtlSUbz55hflYYEl-2nzVakynVd1UlTME9CDIqXtcVtCtkT7LkSmw5els6Rc4__ZfM_-JCjwclEkhmHuCH-QBokCJ65AtQlzBAyVnhpinSR2kuVNqlMa9GqDgUmK0v31J47bd5HahsLnD0_AwpnmSVZZQpmlrC0TMvwt0Mf_p0_rBYfXFqFtbYdbzTt5V3avO1dewrfv1ouUAe-GWnXKJgRyeNHvK_xOw14Q_7HKJN1lFpimdlg_vu=w1088-h1006)

# 재고 조회 시스템 아키텍처 설계 문서

## 1. 개요 (Overview)
애플 이벤트 등 특정 시점에 **재고 조회 API** 트래픽이 **초당 약 5백만 건**까지 폭증할 수 있다.  
이 문서는 관계형 데이터베이스(RDB)로는 감당하기 어려운 대규모 읽기 트래픽을 **무중단(Seamless)으로 확장**하기 위한 시스템 설계 방향을 제시한다.  
데이터 일관성(Consistency)과 성능(Scalability) 간의 트레이드오프가 존재하지만, **결국 읽기 트래픽이 증가해도 안정적으로 대응**할 수 있는 구조가 핵심이다.

---

## 2. 요구사항 (Requirements)
1. **재고 조회 API**:
    - 초당 5,000,000 건 이상의 요청을 처리해야 함.
    - 트래픽 증가(예: 애플 이벤트 시점) 시에도 **원활히 확장** 가능할 것.
2. **읽기 트래픽 중심**:
    - RDB로는 감당이 불가능하므로 NoSQL 기반 아키텍처 고려.
3. **데이터 정합성**:
    - 주문/입고와 같은 쓰기 연산 후, 조회 데이터가 큰 지연 없이 반영되어야 함(완전한 Strong Consistency는 어려울 수 있음).
    - 필요 시 이벤트 기반(Outbox → 메시지 브로커 → Consumer)을 통한 **일관성(Consistency) 보완**.
4. **무중단(Seamless) 스케일 아웃**:
    - 노드 추가를 통해 읽기 처리량을 선형적으로 확장할 수 있어야 함.

---

## 3. 아키텍처 전반 (High-Level Architecture)

1. **API Gateway**
    - 재고 조회 API를 수신하고, **QueryService**(또는 NoSQL DB)로 라우팅.
    - (주문/입고 등 쓰기 API는 참고만, 구체적인 로직은 별도 문서에서 다룸)

2. **데이터 레이어**
    - **NoSQL (Cassandra)**:
        - 대규모 **읽기 트래픽**을 처리하기 위해 채택.
        - 노드를 추가하면 읽기·쓰기 성능이 선형적으로 확장(Scale-out).
        - 이벤트성 트래픽 폭주 시에도 확장성 확보 가능.
    - **스키마(예시)**:
        - 테이블: `stocks`
            - Partition Key: `(vendor_item_id, fulfillment_center_id)`
            - Column: `stock_count`, `updated_at` 등
        - 조회 시:
          ```sql
          SELECT stock_count
          FROM stocks
          WHERE vendor_item_id = :vid
            AND fulfillment_center_id = :fid
          ```
        - 이 구조로 **RDB 대비 훨씬 낮은 지연, 높은 처리량**을 달성.

3. **이벤트 기반 처리 (Outbox + 메시지 브로커)**
    - **Outbox**: 주문/입고 트랜잭션 시 재고 변경 이벤트를 기록(원자적).
    - **메시지 브로커 (Kafka 등)**: Outbox 이벤트를 수집하여 Consumer로 전달.
    - **Consumer**: Cassandra `stocks` 테이블(또는 추가 조회용 테이블)에 필요한 업데이트를 반영.
    - 이를 통해 **데이터 정합성**을 어느 정도 유지하면서, **쓰기 부하와 읽기 부하를 분리**.

---

## 4. 주요 포인트

### 4.1. 왜 RDB가 아닌가?
- **RDB**는 수직 확장(Scale-up) 한계가 있고, **5백만 TPS** 같은 초대형 트래픽을 처리하기 위한 샤딩 설계가 매우 복잡해짐.
- 반면 **Cassandra**는 노드를 늘림에 따라 **선형적**(Linear)으로 읽기 성능을 올릴 수 있음.
### 4.1.2 RDB 샤딩(Sharding) 복잡도
- **수평 확장**을 위해서는 샤딩(Sharding)이 필수.
- MySQL 자체로 대규모 샤딩을 구성하면:
    1) 샤딩 키 결정이 까다롭고,
    2) 샤드 간 트랜잭션, 조인, 인덱스 관리 등이 복잡해짐.
    3) 샤드 증설/축소 시 **스키마 관리**, **리밸런싱** 작업에 많은 리소스 투입.
- 재고가 **N개의 vendor_item**과 **M개의 fulfillment_center**로 분산될 때, 올바른 샤딩 키 설계가 어렵고, 실시간으로 급증하는 트래픽에 대응하기도 번거롭다.

### 4.1.3 쓰기·읽기 분산(Read Replica) 한계
- RDB(Master-Slave) 구조로 **읽기 부하**를 Slave 노드로 분산하려 해도:
    1) **Replication Lag**가 발생해 읽기 일관성이 깨질 수 있음.
    2) Master 노드 부담(쓰기 + binlog 전송)은 여전히 존재.
    3) **Slave 노드** 추가 시 하드웨어 비용 증가, 장애 시 재구성이 복잡.

### 4.1.4 고가용성(HA) 및 무중단 확장 어려움
- MySQL 8 버전에서 Group Replication, InnoDB Cluster 등을 구성해도:
    1) 노드 증설 시 자동 리밸런싱/파티셔닝이 아닌 **별도 작업** 필요.
    2) 쿼리 부하 집중 시 Master 변경, Failover 시 **순간적 다운타임** 불가피.

### 4.1.4 결론
- **수백만 TPS** 규모의 읽기 트래픽을 위해 MySQL 8 기반 RDB를 확장하려면,
    - **복잡한 샤딩** 전략,
    - 여러 **Read Replica** 운용,
    - Cluster/Group Replication 관리 등이 필요하며,
    - 장애 대응 및 운영 비용이 매우 커진다.

> 따라서 **Key-Value/Wide-Column** 중심으로 **선형 확장**이 용이한 **NoSQL(Cassandra)** 전환이 적합하다고 판단.

### 4.2. 데이터 정합성 vs. 성능(확장성)
- Cassandra는 **Eventual Consistency** 모델을 사용(강한 일관성을 특정 조건에서만 허용).
- 주문/입고 시점에 즉시 강한 일관성을 보장하려면 쓰기 지연이 늘어남.
- Outbox+브로커+Consumer 흐름을 사용하면, **이벤트 유실 없이** 조회 DB(또는 Cassandra 테이블)에 반영 가능.
- 결과적으로 **읽기 스케일 아웃**을 우선하며, **일관성은 특정 시간 단위로 빠르게 수렴**하도록 설계.

### 4.3. 읽기 트래픽 증가 대응
- **노드 증설**: Cassandra는 노드를 추가함으로써 읽기·쓰기 처리량을 선형 확대 가능.
- **데이터 파티셔닝**: `(vendor_item_id, fulfillment_center_id)` 같은 복합 파티션 키로 특정 노드에 부하가 몰리지 않도록 설계.
- **모니터링 & 오토스케일링**: CPU, I/O, Latency 지표 등을 모니터링 후, 일정 임계치 이상 도달 시 노드를 자동 추가(무중단).

---

## 5. 동작 시나리오 개요

### 5.1. 재고 조회(Reading Stocks)
1. 클라이언트(또는 사용자) → API Gateway → **QueryService**
2. QueryService → Cassandra (stocks 테이블)
3. Cassandra에서 `stock_count`를 반환
4. QueryService → API Gateway → 클라이언트 응답

> **트래픽 폭주** 시에도 Cassandra 노드 증설을 통해 처리 가능.

### 5.2. 재고 변경(주문/입고)
1. 클라이언트 → API Gateway → **CommandService** (세부 로직은 별도)
2. DB 트랜잭션 과정에서 **Outbox** 테이블에 이벤트 기록 (예: `OrderCreated`)
3. **Outbox Poller/CDC**가 해당 이벤트를 메시지 브로커(Kafka 등)에 발행
4. **Consumer**가 메시지를 수신하고, Cassandra `stocks` 테이블(또는 별도 Read Model)을 업데이트
5. 조회(API)는 업데이트된 `stocks`를 기반으로 최신 재고를 확인 가능

> 이 과정에서 Eventual Consistency가 발생할 수 있으나, 보통 수초 미만(또는 ms 단위) 내에 동기화 가능.

---

## 6. 가용성 확보 방안

1. **Cassandra 클러스터**
    - 다중 노드, Replication Factor 설정으로 **노드 장애** 시에도 Read/Write 가능.
    - 무중단 노드 증설/교체.
2. **메시지 브로커(Kafka)**
    - 다중 브로커, 파티션 복제 설정으로 **브로커 장애** 시에도 파티션 리더 전환.
    - Outbox 기반으로 이벤트를 재시도하므로 메시지 유실 방지.
3. **마이크로서비스**
    - Stateless 인스턴스 설계 + Load Balancer + Auto Scaling.
    - 특정 인스턴스 장애 시 다른 인스턴스로 트래픽을 우회.

---

## 7. 결론
- **5백만 TPS**의 재고 조회 트래픽을 **무중단으로 스케일 아웃**하기 위해 **Cassandra**를 중심으로 설계하였다.
- RDB 대신 NoSQL(Cassandra)을 사용하여, 읽기 부하 증가 시 노드 추가만으로 선형적 확장이 가능하다.
- 데이터 일관성은 **Outbox + 메시지 브로커(Kafka) + Consumer** 구조로 보완하여, **Eventual Consistency**를 유지하면서도 **이벤트 누락 없이** 재고 데이터가 갱신될 수 있도록 했다.
- 장애 상황에서도 **Masterless Cassandra**와 **Replica** 구조를 통해 고가용성(High Availability)을 달성하고, **Autoscaling**을 통해 트래픽 폭주 시 무중단 확장이 가능하다.
- 결과적으로, 대규모 조회 트래픽을 처리함과 동시에 데이터 정합성을 어느 정도 유지하는 아키텍처를 구성할 수 있다.
    
